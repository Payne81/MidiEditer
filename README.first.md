# MidiEditer

|Last modified      |Date                        |
|:------------------|:---------------------------| 
|Payne              |Sun Nov 13 15:52:59 CST 2022|
## 关于项目

最初做这个项目，目的是在工作至于找些喜欢的方向研究和开发点东西出来，也想多了解相关领域的技术现状。
但是一段时间下来已然没有了热情，一方面是工作原因，平时在公司服务设计和维持稳定上消耗了我大部分精力，
闲暇时间有时候更乐意去做在我看来能恢复我生产力的事情；另一方面，项目也从雏形开始有了一个稍微成型的
框架，一起参与开发的朋友时间上也不同步，由此带来的沟通以及开发上的不同步，低效的开发和测试摧毁着我的
开发效率和热情。

关于此算法，以下分成两个部分，需求部分以及实现部分。实现部分又分为MidiFile库的应用和MidiEditer的业务逻辑。

## 需求

此算法最初目标是，接受来自键盘(或电子琴，网页前端)的原始midi数据，根据特定的和弦进行，进行和弦外音的剔除，
音符的量化，去重和延音，音符力度的调整(或者量化)等处理，从而达到能在一段特定的和弦进行中，即兴的旋律能够更
好听(或者更加符合大众的耳朵)

实现上将此几种方法都放到MidiConventer类中， 并定义了各自的处理函数

### 和弦外音的去除

``` cpp
void CleanChordVoiceover(int track);
```

初版算法中包含此部分，但是最初的算法用枚举来定义和弦进行也太傻逼了。如果每次新增一个伴奏都要修改代码，那也太不智能了。

后续版本中网页前端和硬件先后处理了和弦外音剔除的功能，此功能暂时弃用。如果需要重新需要开发此功能，需要重新设计
接口，并重构此部分代码。

### 量化

``` cpp
void QuantifyTrack(int track);
```

量化音头的时间， 并对应音头移动的ticks单位，将音位移动到相同方向相同距离的位置


### 去重

``` cpp
void CleanRecurNotes(int track);
// 数据结构
std::set<MidiNote*> notes;                              // [notes] 表示该文件中出现过的所以音
std::map<int, std::vector<MidiNote*>> block_index;      // block_id -> [note], block_id: 0 -- n-1
                                                        // 表示在此区块出现过的音，一个音可以在多个区块中出现
std::set<MidiNote*>     new_notes;                      // 存储切割后的音
```

在量化之后进行。首先遍历记录所有的音符，以及它们在哪一些区块上。然后根据去重的逻辑保证区块上没有重音，保留变化音（之前的需求）。
切割过后去除掉原来的音，并将切割后的音加入到文件中。

``` cpp
void  CleanRecurNotesNew(int track);    // 这个是想写去重保留最长音的这个需求的，但是测试起来很吔。暂时需要完善（虽然也不需要改多少）
```


### 延音

``` cpp
void ProlongNotes(int track);
```

延长音尾，目前是延长到当前网格结束


### 力度量化

``` cpp
void QualifyVol(int track);
```

实际上没有用到。后续需要力度量化可以参考其中设置力度的方式，其实就是设置音头的音量，音尾的音量设置意义不大。


## 实现

### MidiFile

参考README.midifile.md。

### Editer

MidiNote: MidiEvent对， 一对MidiEvent表示一个音符的起始和结束

### 存在问题以及改进

代码以及开发流程工具等问题：

1. 修改是在原文件上进行的， 假如代码core dump了，前端无法察觉，查记录又比较难查。解决方式: 修改保存到新文件，调用算法的时候检查不到新文件就报错；或者调用程序自行检测core文件(不建议，万一没设置ulimit -c呢)。
2. 建议先开发一个midi可视化的脚本... 不然开发自测非常吔..., 不要考musescore这种来读midi， musescore会做一定处理再展示谱子，要是真看musescore上的来开发自测必定会吔...可以在midireader的基础上开发，或者多打印些日志。或者参考Craig老师midifile库中的Mid2svg来写，将文件转化为图片，或者... cubase/logic装一个）
3. 我怀疑...前端生成midi信号的时候有丢失...有的midi信号有音头但没有结束... 需要检验一下 确实不对劲！用MidiReader读一下，里面的音符对和正常生成的midi文件音符对不上。（2022/11/13, Update: 确实是前端传过来的数据有问题，有的开始事件没有结束事件（MidiReader读出来表现为Duration为0），有的结束事件没有开始事件）
4. 长音被截断成短音原因: 有一个很长的音，跟当前音音高一样但不是一个音，结果选变化音把两者截断了（2022/11/13, Update:原因同上）

项目建议:

1. 需求需要严格评审，开发前需要需求细节的确认，并需要根据需求来设计测试用例
2. 软件质量需要评审，能否验收已经运行的风险需要评估，需要测试用例通过来判断
